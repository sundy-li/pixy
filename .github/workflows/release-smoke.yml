name: Release Smoke

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: "Release tag to validate (for example: v0.1.0). Use latest when empty."
        required: false
        default: "latest"
        type: string

env:
  CARGO_TERM_COLOR: always
  PIXY_REPO: sundy-li/pixy
  PIXY_VERSION: ${{ github.event_name == 'release' && github.event.release.tag_name || github.event.inputs.version || 'latest' }}

jobs:
  install-smoke:
    name: install-smoke-${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Smoke install (Linux / macOS)
        if: runner.os != 'Windows'
        run: |
          export PIXY_INSTALL_DIR="$RUNNER_TEMP/pixy-bin"
          mkdir -p "$PIXY_INSTALL_DIR"
          ./scripts/install.sh --version "$PIXY_VERSION" --repo "$PIXY_REPO" --install-dir "$PIXY_INSTALL_DIR"
          "$PIXY_INSTALL_DIR/pixy" --help >/dev/null
          "$PIXY_INSTALL_DIR/pixy" --version

      - name: Smoke install (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $env:PIXY_INSTALL_DIR = "$env:RUNNER_TEMP\\pixy-bin"
          New-Item -ItemType Directory -Path $env:PIXY_INSTALL_DIR -Force | Out-Null
          & powershell -NoProfile -ExecutionPolicy Bypass -File .\scripts\install.ps1 -Version $env:PIXY_VERSION -Repo $env:PIXY_REPO -InstallDir $env:PIXY_INSTALL_DIR
          & "$env:PIXY_INSTALL_DIR\\pixy.exe" --help | Out-Null
          & "$env:PIXY_INSTALL_DIR\\pixy.exe" --version
